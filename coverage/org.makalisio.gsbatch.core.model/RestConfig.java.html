<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="fr"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>RestConfig.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">gsbatch</a> &gt; <a href="index.source.html" class="el_package">org.makalisio.gsbatch.core.model</a> &gt; <span class="el_source">RestConfig.java</span></div><h1>RestConfig.java</h1><pre class="source lang-java linenums">package org.makalisio.gsbatch.core.model;

import lombok.Getter;
import lombok.NoArgsConstructor;
import lombok.Setter;
import lombok.ToString;

import java.util.HashMap;
import java.util.List;
import java.util.Map;

/**
 * REST API configuration for the YAML source.
 *
 * &lt;p&gt;Supports paginated HTTP calls with authentication, retry logic,
 * and JSON extraction via JsonPath.&lt;/p&gt;
 *
 * &lt;h2&gt;Example YAML&lt;/h2&gt;
 * &lt;pre&gt;
 * rest:
 *   url: https://api.bank.com/v2/orders
 *   method: GET
 *   queryParams:
 *     status:     :status          # bind from jobParameters
 *     trade_date: :process_date
 *   headers:
 *     Accept: application/json
 *   auth:
 *     type: API_KEY
 *     apiKey: ${API_KEY_ORDERS}    # resolved from env var
 *     headerName: X-Api-Key
 *   dataPath: $.data.orders
 *   pagination:
 *     strategy: PAGE_SIZE
 *     pageParam: page
 *     sizeParam: size
 *     pageSize: 100
 *     totalPath: $.meta.total
 *   retry:
 *     maxRetries: 3
 *     retryDelay: 2000
 *     retryOnHttpCodes: [429, 503, 504]
 * &lt;/pre&gt;
 *
 * @author Makalisio
 * @since 0.0.1
 */
@Getter
<span class="nc" id="L49">@Setter</span>
<span class="fc" id="L50">@NoArgsConstructor</span>
<span class="nc" id="L51">@ToString</span>
public class RestConfig {

    // ── HTTP REQUEST ─────────────────────────────────────────────────────────

    /**
     * Base URL of the REST API endpoint.
     * Can contain bind variables like :paramName resolved from jobParameters.
     * Example: &quot;https://api.bank.com/v2/orders&quot;
     */
<span class="nc" id="L61">    private String url;</span>

    /**
     * HTTP method. Default: GET.
     * Supported: GET, POST (for POST pagination or search APIs).
     */
<span class="pc" id="L67">    private String method = &quot;GET&quot;;</span>

    /**
     * Query parameters to append to the URL.
     * Values can be static strings or bind variables (:paramName).
     * Example: {status: &quot;:status&quot;, trade_date: &quot;:process_date&quot;}
     */
<span class="pc" id="L74">    private Map&lt;String, String&gt; queryParams = new HashMap&lt;&gt;();</span>

    /**
     * HTTP headers to include in every request.
     * Example: {Accept: &quot;application/json&quot;, X-Client-Id: &quot;backoffice&quot;}
     */
<span class="pc" id="L80">    private Map&lt;String, String&gt; headers = new HashMap&lt;&gt;();</span>

    /**
     * Optional request body for POST requests.
     * Can contain bind variables (:paramName).
     * JSON format expected.
     */
<span class="nc" id="L87">    private String body;</span>

    // ── AUTHENTICATION ───────────────────────────────────────────────────────

    /**
     * Authentication configuration.
     */
<span class="pc" id="L94">    private AuthConfig auth = new AuthConfig();</span>

    @Getter
<span class="nc" id="L97">    @Setter</span>
<span class="fc" id="L98">    @NoArgsConstructor</span>
<span class="nc" id="L99">    @ToString</span>
    public static class AuthConfig {
        /**
         * Authentication type: NONE | API_KEY | BEARER | OAUTH2_CLIENT_CREDENTIALS.
         * Default: NONE.
         */
<span class="pc" id="L105">        private String type = &quot;NONE&quot;;</span>

        /**
         * API key value (used when type=API_KEY).
         * Supports ${VAR} syntax for environment variable resolution.
         * Example: &quot;${API_KEY_ORDERS}&quot;
         */
<span class="nc" id="L112">        private String apiKey;</span>

        /**
         * HTTP header name for the API key (used when type=API_KEY).
         * Default: &quot;X-Api-Key&quot;
         */
<span class="pc" id="L118">        private String headerName = &quot;X-Api-Key&quot;;</span>

        /**
         * Bearer token value (used when type=BEARER).
         * Supports ${VAR} syntax.
         */
<span class="nc" id="L124">        private String bearerToken;</span>

        /**
         * OAuth2 token endpoint URL (used when type=OAUTH2_CLIENT_CREDENTIALS).
         */
<span class="nc" id="L129">        private String tokenUrl;</span>

        /**
         * OAuth2 client ID. Supports ${VAR} syntax.
         */
<span class="nc" id="L134">        private String clientId;</span>

        /**
         * OAuth2 client secret. Supports ${VAR} syntax.
         */
<span class="nc" id="L139">        private String clientSecret;</span>

        /**
         * OAuth2 scope (optional).
         */
<span class="nc" id="L144">        private String scope;</span>
    }

    // ── JSON EXTRACTION ──────────────────────────────────────────────────────

    /**
     * JsonPath expression to extract the array of items from the JSON response.
     * Example: &quot;$.data.orders&quot; for {&quot;data&quot;: {&quot;orders&quot;: [...]}}
     * If the array is at the root, use &quot;$&quot; or &quot;$.&quot;.
     */
<span class="pc" id="L154">    private String dataPath = &quot;$&quot;;</span>

    // ── PAGINATION ───────────────────────────────────────────────────────────

    /**
     * Pagination configuration.
     */
<span class="pc" id="L161">    private PaginationConfig pagination = new PaginationConfig();</span>

    @Getter
<span class="nc" id="L164">    @Setter</span>
<span class="fc" id="L165">    @NoArgsConstructor</span>
<span class="nc" id="L166">    @ToString</span>
    public static class PaginationConfig {
        /**
         * Pagination strategy.
         * Supported: NONE | PAGE_SIZE | OFFSET_LIMIT | CURSOR | LINK_HEADER.
         * Default: NONE (entire dataset returned in one call).
         */
<span class="pc" id="L173">        private String strategy = &quot;NONE&quot;;</span>

        /**
         * Query parameter name for the page number (PAGE_SIZE strategy).
         * Example: &quot;page&quot; for ?page=0&amp;size=100
         */
<span class="pc" id="L179">        private String pageParam = &quot;page&quot;;</span>

        /**
         * Query parameter name for the page size (PAGE_SIZE or OFFSET_LIMIT).
         * Example: &quot;size&quot; for ?page=0&amp;size=100
         */
<span class="pc" id="L185">        private String sizeParam = &quot;size&quot;;</span>

        /**
         * Number of items per page.
         * Default: 100.
         */
<span class="pc" id="L191">        private int pageSize = 100;</span>

        /**
         * Query parameter name for the offset (OFFSET_LIMIT strategy).
         * Example: &quot;offset&quot; for ?offset=0&amp;limit=100
         */
<span class="pc" id="L197">        private String offsetParam = &quot;offset&quot;;</span>

        /**
         * Query parameter name for the limit (OFFSET_LIMIT strategy).
         * Example: &quot;limit&quot; for ?offset=0&amp;limit=100
         */
<span class="pc" id="L203">        private String limitParam = &quot;limit&quot;;</span>

        /**
         * JsonPath to extract the cursor value from the response (CURSOR strategy).
         * Example: &quot;$.meta.nextCursor&quot;
         */
<span class="nc" id="L209">        private String cursorPath;</span>

        /**
         * Query parameter name for the cursor (CURSOR strategy).
         * Example: &quot;cursor&quot; for ?cursor=abc123
         */
<span class="pc" id="L215">        private String cursorParam = &quot;cursor&quot;;</span>

        /**
         * JsonPath to extract the total item count from the response (optional).
         * Used for logging progress.
         * Example: &quot;$.meta.total&quot;
         */
<span class="nc" id="L222">        private String totalPath;</span>
    }

    // ── RETRY ────────────────────────────────────────────────────────────────

    /**
     * Retry configuration for transient HTTP errors.
     */
<span class="pc" id="L230">    private RetryConfig retry = new RetryConfig();</span>

    @Getter
<span class="nc" id="L233">    @Setter</span>
<span class="fc" id="L234">    @NoArgsConstructor</span>
<span class="nc" id="L235">    @ToString</span>
    public static class RetryConfig {
        /**
         * Maximum number of retry attempts.
         * Default: 3.
         */
<span class="pc" id="L241">        private int maxRetries = 3;</span>

        /**
         * Delay between retries in milliseconds.
         * Default: 2000 (2 seconds).
         */
<span class="pc" id="L247">        private long retryDelay = 2000L;</span>

        /**
         * HTTP status codes that trigger a retry.
         * Default: [429, 503, 504] (Too Many Requests, Service Unavailable, Gateway Timeout).
         */
<span class="pc" id="L253">        private List&lt;Integer&gt; retryOnHttpCodes = List.of(429, 503, 504);</span>
    }

    // ── VALIDATION ───────────────────────────────────────────────────────────

    /**
     * Validates the REST configuration.
     *
     * @throws IllegalStateException if the configuration is invalid
     */
    public void validate() {
<span class="nc bnc" id="L264" title="All 4 branches missed.">        if (url == null || url.isBlank()) {</span>
<span class="nc" id="L265">            throw new IllegalStateException(&quot;rest.url is required&quot;);</span>
        }

<span class="nc bnc" id="L268" title="All 4 branches missed.">        if (method == null || method.isBlank()) {</span>
<span class="nc" id="L269">            throw new IllegalStateException(&quot;rest.method is required&quot;);</span>
        }

<span class="nc bnc" id="L272" title="All 2 branches missed.">        if (!List.of(&quot;GET&quot;, &quot;POST&quot;).contains(method.toUpperCase())) {</span>
<span class="nc" id="L273">            throw new IllegalStateException(</span>
                &quot;rest.method must be GET or POST, got: &quot; + method);
        }

<span class="nc bnc" id="L277" title="All 4 branches missed.">        if (dataPath == null || dataPath.isBlank()) {</span>
<span class="nc" id="L278">            throw new IllegalStateException(&quot;rest.dataPath is required&quot;);</span>
        }

        // Validate auth
<span class="nc" id="L282">        String authType = auth.getType().toUpperCase();</span>
<span class="nc bnc" id="L283" title="All 2 branches missed.">        if (!List.of(&quot;NONE&quot;, &quot;API_KEY&quot;, &quot;BEARER&quot;, &quot;OAUTH2_CLIENT_CREDENTIALS&quot;).contains(authType)) {</span>
<span class="nc" id="L284">            throw new IllegalStateException(</span>
                &quot;rest.auth.type must be NONE, API_KEY, BEARER, or OAUTH2_CLIENT_CREDENTIALS, got: &quot; + authType);
        }

<span class="nc bnc" id="L288" title="All 6 branches missed.">        if (&quot;API_KEY&quot;.equals(authType) &amp;&amp; (auth.getApiKey() == null || auth.getApiKey().isBlank())) {</span>
<span class="nc" id="L289">            throw new IllegalStateException(&quot;rest.auth.apiKey is required when type=API_KEY&quot;);</span>
        }

<span class="nc bnc" id="L292" title="All 6 branches missed.">        if (&quot;BEARER&quot;.equals(authType) &amp;&amp; (auth.getBearerToken() == null || auth.getBearerToken().isBlank())) {</span>
<span class="nc" id="L293">            throw new IllegalStateException(&quot;rest.auth.bearerToken is required when type=BEARER&quot;);</span>
        }

<span class="nc bnc" id="L296" title="All 2 branches missed.">        if (&quot;OAUTH2_CLIENT_CREDENTIALS&quot;.equals(authType)) {</span>
<span class="nc bnc" id="L297" title="All 4 branches missed.">            if (auth.getTokenUrl() == null || auth.getTokenUrl().isBlank()) {</span>
<span class="nc" id="L298">                throw new IllegalStateException(&quot;rest.auth.tokenUrl is required when type=OAUTH2_CLIENT_CREDENTIALS&quot;);</span>
            }
<span class="nc bnc" id="L300" title="All 4 branches missed.">            if (auth.getClientId() == null || auth.getClientId().isBlank()) {</span>
<span class="nc" id="L301">                throw new IllegalStateException(&quot;rest.auth.clientId is required when type=OAUTH2_CLIENT_CREDENTIALS&quot;);</span>
            }
<span class="nc bnc" id="L303" title="All 4 branches missed.">            if (auth.getClientSecret() == null || auth.getClientSecret().isBlank()) {</span>
<span class="nc" id="L304">                throw new IllegalStateException(&quot;rest.auth.clientSecret is required when type=OAUTH2_CLIENT_CREDENTIALS&quot;);</span>
            }
        }

        // Validate pagination
<span class="nc" id="L309">        String paginationStrategy = pagination.getStrategy().toUpperCase();</span>
<span class="nc bnc" id="L310" title="All 2 branches missed.">        if (!List.of(&quot;NONE&quot;, &quot;PAGE_SIZE&quot;, &quot;OFFSET_LIMIT&quot;, &quot;CURSOR&quot;, &quot;LINK_HEADER&quot;).contains(paginationStrategy)) {</span>
<span class="nc" id="L311">            throw new IllegalStateException(</span>
                &quot;rest.pagination.strategy must be NONE, PAGE_SIZE, OFFSET_LIMIT, CURSOR, or LINK_HEADER, got: &quot; +
                paginationStrategy);
        }

<span class="nc bnc" id="L316" title="All 2 branches missed.">        if (&quot;PAGE_SIZE&quot;.equals(paginationStrategy)) {</span>
<span class="nc bnc" id="L317" title="All 4 branches missed.">            if (pagination.getPageParam() == null || pagination.getPageParam().isBlank()) {</span>
<span class="nc" id="L318">                throw new IllegalStateException(&quot;rest.pagination.pageParam is required when strategy=PAGE_SIZE&quot;);</span>
            }
<span class="nc bnc" id="L320" title="All 4 branches missed.">            if (pagination.getSizeParam() == null || pagination.getSizeParam().isBlank()) {</span>
<span class="nc" id="L321">                throw new IllegalStateException(&quot;rest.pagination.sizeParam is required when strategy=PAGE_SIZE&quot;);</span>
            }
        }

<span class="nc bnc" id="L325" title="All 2 branches missed.">        if (&quot;OFFSET_LIMIT&quot;.equals(paginationStrategy)) {</span>
<span class="nc bnc" id="L326" title="All 4 branches missed.">            if (pagination.getOffsetParam() == null || pagination.getOffsetParam().isBlank()) {</span>
<span class="nc" id="L327">                throw new IllegalStateException(&quot;rest.pagination.offsetParam is required when strategy=OFFSET_LIMIT&quot;);</span>
            }
<span class="nc bnc" id="L329" title="All 4 branches missed.">            if (pagination.getLimitParam() == null || pagination.getLimitParam().isBlank()) {</span>
<span class="nc" id="L330">                throw new IllegalStateException(&quot;rest.pagination.limitParam is required when strategy=OFFSET_LIMIT&quot;);</span>
            }
        }

<span class="nc bnc" id="L334" title="All 2 branches missed.">        if (&quot;CURSOR&quot;.equals(paginationStrategy)) {</span>
<span class="nc bnc" id="L335" title="All 4 branches missed.">            if (pagination.getCursorPath() == null || pagination.getCursorPath().isBlank()) {</span>
<span class="nc" id="L336">                throw new IllegalStateException(&quot;rest.pagination.cursorPath is required when strategy=CURSOR&quot;);</span>
            }
<span class="nc bnc" id="L338" title="All 4 branches missed.">            if (pagination.getCursorParam() == null || pagination.getCursorParam().isBlank()) {</span>
<span class="nc" id="L339">                throw new IllegalStateException(&quot;rest.pagination.cursorParam is required when strategy=CURSOR&quot;);</span>
            }
        }

<span class="nc bnc" id="L343" title="All 2 branches missed.">        if (pagination.getPageSize() &lt;= 0) {</span>
<span class="nc" id="L344">            throw new IllegalStateException(&quot;rest.pagination.pageSize must be positive&quot;);</span>
        }

        // Validate retry
<span class="nc bnc" id="L348" title="All 2 branches missed.">        if (retry.getMaxRetries() &lt; 0) {</span>
<span class="nc" id="L349">            throw new IllegalStateException(&quot;rest.retry.maxRetries must be &gt;= 0&quot;);</span>
        }

<span class="nc bnc" id="L352" title="All 2 branches missed.">        if (retry.getRetryDelay() &lt; 0) {</span>
<span class="nc" id="L353">            throw new IllegalStateException(&quot;rest.retry.retryDelay must be &gt;= 0&quot;);</span>
        }
<span class="nc" id="L355">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>