<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="fr"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>GenericItemWriterFactory.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">gsbatch</a> &gt; <a href="index.source.html" class="el_package">org.makalisio.gsbatch.core.writer</a> &gt; <span class="el_source">GenericItemWriterFactory.java</span></div><h1>GenericItemWriterFactory.java</h1><pre class="source lang-java linenums">package org.makalisio.gsbatch.core.writer;

import lombok.extern.slf4j.Slf4j;
import org.makalisio.gsbatch.core.model.GenericRecord;
import org.makalisio.gsbatch.core.model.SourceConfig;
import org.makalisio.gsbatch.core.model.WriterConfig;
import org.makalisio.gsbatch.core.reader.SqlFileLoader;
import org.springframework.batch.item.ItemWriter;
import org.springframework.beans.factory.BeanFactory;
import org.springframework.context.ApplicationContext;
import org.springframework.stereotype.Component;

import javax.sql.DataSource;

/**
 * Factory for creating {@code ItemWriter} instances based on the YAML configuration.
 *
 * &lt;h2&gt;Writer resolution order&lt;/h2&gt;
 * &lt;ol&gt;
 *   &lt;li&gt;If {@code writer.type=SQL} in the YAML → {@link SqlGenericItemWriter}&lt;/li&gt;
 *   &lt;li&gt;If {@code writer.type=JAVA} in the YAML → bean named {@code writer.beanName}&lt;/li&gt;
 *   &lt;li&gt;If {@code writer} is absent from the YAML → bean named {@code {sourceName}Writer}
 *       (legacy behaviour)&lt;/li&gt;
 * &lt;/ol&gt;
 *
 * @author Makalisio
 * @since 0.0.1
 */
<span class="fc" id="L29">@Slf4j</span>
@Component
public class GenericItemWriterFactory {

    private final ApplicationContext applicationContext;
    private final SqlFileLoader sqlFileLoader;
    private final DataSource defaultDataSource;
    private final BeanFactory beanFactory;

    /**
     * @param applicationContext Spring context for resolving JAVA beans
     * @param sqlFileLoader      SQL file loader
     * @param defaultDataSource  primary DataSource
     * @param beanFactory        for resolving named DataSources
     */
    public GenericItemWriterFactory(ApplicationContext applicationContext,
                                    SqlFileLoader sqlFileLoader,
                                    DataSource defaultDataSource,
<span class="fc" id="L47">                                    BeanFactory beanFactory) {</span>
<span class="fc" id="L48">        this.applicationContext = applicationContext;</span>
<span class="fc" id="L49">        this.sqlFileLoader = sqlFileLoader;</span>
<span class="fc" id="L50">        this.defaultDataSource = defaultDataSource;</span>
<span class="fc" id="L51">        this.beanFactory = beanFactory;</span>
<span class="fc" id="L52">        log.info(&quot;GenericItemWriterFactory initialized&quot;);</span>
<span class="fc" id="L53">    }</span>

    /**
     * Builds an {@code ItemWriter} according to the YAML configuration.
     *
     * @param config the source configuration
     * @return configured writer
     */
    public ItemWriter&lt;GenericRecord&gt; buildWriter(SourceConfig config) {
<span class="fc bfc" id="L62" title="All 2 branches covered.">        if (config == null) {</span>
<span class="fc" id="L63">            throw new IllegalArgumentException(&quot;SourceConfig cannot be null&quot;);</span>
        }

        // ── Case 1: WriterConfig declared in the YAML ─────────────────────────
<span class="fc bfc" id="L67" title="All 2 branches covered.">        if (config.hasWriterConfig()) {</span>
<span class="fc" id="L68">            return buildFromWriterConfig(config);</span>
        }

        // ── Case 2: legacy behaviour - bean &quot;{sourceName}Writer&quot; ──────────────
<span class="fc" id="L72">        return buildFromBeanConvention(config);</span>
    }

    // ─────────────────────────────────────────────────────────────────────────
    //  Case 1: declarative WriterConfig
    // ─────────────────────────────────────────────────────────────────────────

    private ItemWriter&lt;GenericRecord&gt; buildFromWriterConfig(SourceConfig config) {
<span class="fc" id="L80">        WriterConfig writerConfig = config.getWriter();</span>
<span class="fc" id="L81">        String type = writerConfig.getType();</span>
<span class="fc" id="L82">        log.debug(&quot;Source '{}' - declarative writer, type={}&quot;, config.getName(), type);</span>

<span class="fc bfc" id="L84" title="All 2 branches covered.">        if (&quot;SQL&quot;.equalsIgnoreCase(type)) {</span>
<span class="fc" id="L85">            return buildSqlWriter(config, writerConfig);</span>
<span class="pc bpc" id="L86" title="1 of 2 branches missed.">        } else if (&quot;JAVA&quot;.equalsIgnoreCase(type)) {</span>
<span class="fc" id="L87">            return buildJavaWriter(config, writerConfig.getBeanName());</span>
        } else {
<span class="nc" id="L89">            throw new IllegalStateException(</span>
<span class="nc" id="L90">                    &quot;Invalid writer.type for source '&quot; + config.getName() +</span>
                            &quot;': '&quot; + type + &quot;'. Accepted values: SQL, JAVA&quot;
            );
        }
    }

    /**
     * Builds a {@link SqlGenericItemWriter} from the SQL file.
     */
    private ItemWriter&lt;GenericRecord&gt; buildSqlWriter(SourceConfig config, WriterConfig writerConfig) {
<span class="fc" id="L100">        DataSource dataSource = resolveDataSource(writerConfig.getDataSourceBean(), config.getName());</span>

<span class="fc" id="L102">        log.info(&quot;Source '{}' - SQL writer: {}/{}&quot;,</span>
<span class="fc" id="L103">                config.getName(), writerConfig.getSqlDirectory(), writerConfig.getSqlFile());</span>

<span class="fc" id="L105">        return new SqlGenericItemWriter(writerConfig, sqlFileLoader, dataSource, config.getName());</span>
    }

    /**
     * Resolves a Java {@code ItemWriter} bean from the Spring context.
     */
    private ItemWriter&lt;GenericRecord&gt; buildJavaWriter(SourceConfig config, String beanName) {
<span class="fc" id="L112">        log.info(&quot;Source '{}' - JAVA writer bean: '{}'&quot;, config.getName(), beanName);</span>
<span class="fc" id="L113">        return resolveWriterBean(beanName, config.getName());</span>
    }

    // ─────────────────────────────────────────────────────────────────────────
    //  Case 2: convention {sourceName}Writer (legacy behaviour)
    // ─────────────────────────────────────────────────────────────────────────

    private ItemWriter&lt;GenericRecord&gt; buildFromBeanConvention(SourceConfig config) {
<span class="fc" id="L121">        String sourceName = config.getName();</span>
<span class="fc" id="L122">        String beanName = sourceName + &quot;Writer&quot;;</span>

        // Try direct name first (e.g., &quot;calculator-soapWriter&quot;)
<span class="fc bfc" id="L125" title="All 2 branches covered.">        if (applicationContext.containsBean(beanName)) {</span>
<span class="fc" id="L126">            log.debug(&quot;Source '{}' - convention-based writer, using bean '{}'&quot;, sourceName, beanName);</span>
<span class="fc" id="L127">            return resolveWriterBean(beanName, sourceName);</span>
        }

        // Fallback: try camelCase (e.g., &quot;calculatorSoapWriter&quot;) when sourceName contains hyphens
<span class="fc bfc" id="L131" title="All 2 branches covered.">        if (sourceName.contains(&quot;-&quot;)) {</span>
<span class="fc" id="L132">            String camelCaseBeanName = toCamelCase(sourceName) + &quot;Writer&quot;;</span>
<span class="pc bpc" id="L133" title="1 of 2 branches missed.">            if (applicationContext.containsBean(camelCaseBeanName)) {</span>
<span class="fc" id="L134">                log.debug(&quot;Source '{}' - convention-based writer, using camelCase bean '{}'&quot;,</span>
                        sourceName, camelCaseBeanName);
<span class="fc" id="L136">                return resolveWriterBean(camelCaseBeanName, sourceName);</span>
            }
        }

        // Neither found — delegate to resolveWriterBean which throws a descriptive error
<span class="fc" id="L141">        log.debug(&quot;Source '{}' - convention-based writer, looking for bean '{}'&quot;, sourceName, beanName);</span>
<span class="nc" id="L142">        return resolveWriterBean(beanName, sourceName);</span>
    }

    /**
     * Converts a hyphenated name to lowerCamelCase.
     * Example: &quot;exchange-rates-frankfurter&quot; → &quot;exchangeRatesFrankfurter&quot;
     */
    private static String toCamelCase(String hyphenated) {
<span class="fc" id="L150">        String[] parts = hyphenated.split(&quot;-&quot;);</span>
<span class="fc" id="L151">        StringBuilder sb = new StringBuilder(parts[0]);</span>
<span class="fc bfc" id="L152" title="All 2 branches covered.">        for (int i = 1; i &lt; parts.length; i++) {</span>
<span class="pc bpc" id="L153" title="1 of 2 branches missed.">            if (!parts[i].isEmpty()) {</span>
<span class="fc" id="L154">                sb.append(Character.toUpperCase(parts[i].charAt(0)));</span>
<span class="fc" id="L155">                sb.append(parts[i].substring(1));</span>
            }
        }
<span class="fc" id="L158">        return sb.toString();</span>
    }

    // ─────────────────────────────────────────────────────────────────────────
    //  Helpers
    // ─────────────────────────────────────────────────────────────────────────

    /**
     * Resolves an {@code ItemWriter} bean from the Spring context.
     */
    @SuppressWarnings(&quot;unchecked&quot;)
    private ItemWriter&lt;GenericRecord&gt; resolveWriterBean(String beanName, String sourceName) {
<span class="fc bfc" id="L170" title="All 2 branches covered.">        if (!applicationContext.containsBean(beanName)) {</span>
<span class="fc" id="L171">            throw new IllegalStateException(String.format(</span>
                    &quot;No writer found for source '%s'.%n&quot; +
                            &quot;Option 1 (declarative): add a 'writer:' section in %s.yml%n&quot; +
                            &quot;Option 2 (convention): create a @Component(\&quot;%s\&quot;) implementing ItemWriter&lt;GenericRecord&gt;&quot;,
                    sourceName, sourceName, beanName
            ));
        }

<span class="fc" id="L179">        Object bean = applicationContext.getBean(beanName);</span>
<span class="fc bfc" id="L180" title="All 2 branches covered.">        if (!(bean instanceof ItemWriter)) {</span>
<span class="fc" id="L181">            throw new IllegalStateException(String.format(</span>
                    &quot;Bean '%s' does not implement ItemWriter. Actual type: %s&quot;,
<span class="fc" id="L183">                    beanName, bean.getClass().getName()</span>
            ));
        }

<span class="fc" id="L187">        log.info(&quot;Source '{}' - writer bean '{}' resolved&quot;, sourceName, beanName);</span>
<span class="fc" id="L188">        return (ItemWriter&lt;GenericRecord&gt;) bean;</span>
    }

    /**
     * Resolves the DataSource (named or primary).
     */
    private DataSource resolveDataSource(String dataSourceBeanName, String sourceName) {
<span class="pc bpc" id="L195" title="1 of 4 branches missed.">        if (dataSourceBeanName != null &amp;&amp; !dataSourceBeanName.isBlank()) {</span>
<span class="fc" id="L196">            log.debug(&quot;Source '{}' - named DataSource: '{}'&quot;, sourceName, dataSourceBeanName);</span>
<span class="fc" id="L197">            return beanFactory.getBean(dataSourceBeanName, DataSource.class);</span>
        }
<span class="fc" id="L199">        return defaultDataSource;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>